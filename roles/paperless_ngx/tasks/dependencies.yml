---
- name: Install system dependencies
  ansible.builtin.package:
    name:
      - python3
      - python3-pip
      - python3-dev
      - python3-venv
      - imagemagick
      - fonts-liberation
      - gnupg
      - libpq-dev
      - default-libmysqlclient-dev
      - pkg-config
      - libmagic-dev
      - libzbar0
      - poppler-utils
      - unpaper
      - ghostscript
      - icc-profiles-free
      - qpdf
      - liblept5
      - libxml2
      - pngquant
      - zlib1g
      - tesseract-ocr
      - tesseract-ocr-{{ paperless_ocr_language }}
      - build-essential
      - python3-setuptools
      - python3-wheel
    state: present

- name: Install and configure Redis
  ansible.builtin.package:
    name: redis-server
    state: present

- name: Ensure Redis is started and enabled
  ansible.builtin.systemd:
    name: redis-server
    state: started
    enabled: true

- name: Install PostgreSQL
  ansible.builtin.package:
    name:
      - postgresql
      - postgresql-contrib
      - python3-psycopg2
    state: present
  when: >
    paperless_dbengine == "postgres" and
    not (paperless_db_url | default('') | length > 0)

- name: Ensure PostgreSQL is started and enabled
  ansible.builtin.systemd:
    name: postgresql
    state: started
    enabled: true
  become: true
  when: >
    paperless_dbengine == "postgres" and
    not (paperless_db_url | default('') | length > 0)

- name: Create PostgreSQL user
  ansible.builtin.shell:
    cmd: >
      su - postgres -c
      "psql -c \"CREATE USER {{ paperless_dbuser }} WITH PASSWORD '{{ paperless_db_password }}';\""
  register: user_create_result
  changed_when: user_create_result.rc == 0
  failed_when: user_create_result.rc != 0 and 'already exists' not in user_create_result.stderr | default('')
  become: true
  when: >
    paperless_dbengine == "postgres" and
    not (paperless_db_url | default('') | length > 0)
  # noqa: command-instead-of-shell - su - postgres requires shell

- name: Ensure PostgreSQL user password is set
  ansible.builtin.shell:
    cmd: >
      su - postgres -c
      "psql -c \"ALTER USER {{ paperless_dbuser }} WITH PASSWORD '{{ paperless_db_password }}';\""
  register: password_set_result
  changed_when: password_set_result.rc == 0
  become: true
  no_log: true
  when: >
    paperless_dbengine == "postgres" and
    not (paperless_db_url | default('') | length > 0)
  # noqa: command-instead-of-shell - su - postgres requires shell
  tags:
    - paperless
    - database

- name: Create PostgreSQL database
  ansible.builtin.shell:
    cmd: >
      su - postgres -c
      "createdb --encoding=UTF8 --lc-collate=C --lc-ctype=C --template=template0 --owner={{ paperless_dbuser }} '{{ paperless_dbname }}'"
  register: db_create_result
  changed_when: db_create_result.rc == 0
  failed_when: db_create_result.rc != 0 and 'already exists' not in db_create_result.stderr | default('')
  become: true
  when: >
    paperless_dbengine == "postgres" and
    not (paperless_db_url | default('') | length > 0)
  # noqa: command-instead-of-shell - su - postgres requires shell

- name: Grant privileges on database
  ansible.builtin.shell:
    cmd: >
      su - postgres -c
      "psql -c \"GRANT ALL PRIVILEGES ON DATABASE {{ paperless_dbname }} TO {{ paperless_dbuser }};\""
  register: grant_db_result
  changed_when: grant_db_result.rc == 0
  become: true
  when: >
    paperless_dbengine == "postgres" and
    not (paperless_db_url | default('') | length > 0)
  # noqa: command-instead-of-shell - su - postgres requires shell

- name: Grant privileges on schema public
  ansible.builtin.shell:
    cmd: >
      su - postgres -c
      "psql -d {{ paperless_dbname }} -c \"ALTER SCHEMA public OWNER TO {{ paperless_dbuser }}; GRANT ALL ON SCHEMA public TO {{ paperless_dbuser }};\""
  register: schema_result
  changed_when: schema_result.rc == 0
  become: true
  when: >
    paperless_dbengine == "postgres" and
    not (paperless_db_url | default('') | length > 0)
  # noqa: command-instead-of-shell - su - postgres requires shell
